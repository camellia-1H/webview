<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tafusuma Login - WebView Demo</title>
    <!-- ... existing styles ... -->
</head>
<body>
    <!-- ... existing HTML ... -->
    
    <script>
        // ==================== STATE MANAGEMENT ====================
        let biometricEnabled = false;
        let isLoggedIn = false;
        const debugLog = [];

        // ==================== DOM ELEMENTS ====================
        const loginForm = document.getElementById('loginForm');
        const userIdInput = document.getElementById('userId');
        const passwordInput = document.getElementById('password');
        const toggleSwitch = document.getElementById('toggleSwitch');
        const biometricLoginBtn = document.getElementById('biometricLoginBtn');
        const statusMessage = document.getElementById('statusMessage');
        const debugLogElement = document.getElementById('debugLog');

        // ==================== UTILITY FUNCTIONS ====================
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            debugLog.push(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
            debugLogElement.textContent = debugLog.slice(-10).join('\n');
        }

        function showMessage(message, type = 'info') {
            statusMessage.textContent = message;
            statusMessage.className = `status-message show ${type}`;
            setTimeout(() => {
                statusMessage.classList.remove('show');
            }, 3000);
        }

        // ==================== SEND TO FLUTTER APP ====================
        function sendToApp(key, value) {
            const message = `${key}=${value}`;
            addLog(`Sending to app: ${message}`, 'info');
            
            if (window.nativeMethod) {
                window.nativeMethod.postMessage(message);
                addLog('‚úì Message sent via nativeMethod', 'success');
            } else {
                addLog('‚ö† nativeMethod channel not found', 'error');
            }
        }

        // ==================== BIOMETRIC TOGGLE ====================
        toggleSwitch.addEventListener('click', () => {
            biometricEnabled = !biometricEnabled;
            toggleSwitch.classList.toggle('active');
            
            if (biometricEnabled) {
                addLog('Biometric enabled by user', 'success');
                showMessage('Sinh tr·∫Øc h·ªçc ƒë√£ ƒë∆∞·ª£c b·∫≠t', 'success');
            } else {
                addLog('Biometric disabled by user', 'info');
                showMessage('Sinh tr·∫Øc h·ªçc ƒë√£ ƒë∆∞·ª£c t·∫Øt', 'info');
                localStorage.removeItem('biometricEnabled');
                biometricLoginBtn.classList.remove('show');
            }
        });

        // ==================== NORMAL LOGIN ====================
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const userId = userIdInput.value;
            const password = passwordInput.value;

            if (!userId || !password) {
                showMessage('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin', 'error');
                return;
            }

            addLog(`Login attempt: userId=${userId}`, 'info');

            if (biometricEnabled) {
                // L·∫¶N ƒê·∫¶U: G·ª≠i credentials v·ªÅ app ƒë·ªÉ l∆∞u v√†o secure storage
                // Format: biometric=save_credentials:userId:password
                const credentials = `save_credentials:${userId}:${password}`;
                sendToApp('biometric', credentials);
                
                localStorage.setItem('biometricEnabled', 'true');
                localStorage.setItem('lastUserId', userId);

                showMessage('‚úÖ ƒêƒÉng nh·∫≠p th√†nh c√¥ng! Sinh tr·∫Øc h·ªçc ƒë√£ ƒë∆∞·ª£c c·∫•u h√¨nh.', 'success');
                biometricLoginBtn.classList.add('show');
                
            } else {
                addLog('Normal login (biometric not enabled)', 'info');
                showMessage('‚úÖ ƒêƒÉng nh·∫≠p th√†nh c√¥ng!', 'success');
            }

            isLoggedIn = true;
        });

        // ==================== BIOMETRIC LOGIN ====================
        biometricLoginBtn.addEventListener('click', () => {
            addLog('Requesting biometric authentication', 'info');
            showMessage('üîê ƒêang x√°c th·ª±c sinh tr·∫Øc h·ªçc...', 'info');
            
            // G·ª≠i y√™u c·∫ßu l·∫•y credentials t·ª´ app
            sendToApp('biometric', 'request_credentials');
        });

        // ==================== CALLBACKS FROM FLUTTER APP ====================
        
        // Callback khi app l∆∞u credentials th√†nh c√¥ng
        window.credentialsSaved = function(status) {
            addLog(`Credentials saved: ${status}`, 'success');
            if (status === 'success') {
                showMessage('‚úÖ Th√¥ng tin ƒë√£ ƒë∆∞·ª£c l∆∞u an to√†n!', 'success');
            }
        };

        // Callback khi app g·ª≠i credentials v·ªÅ sau khi x√°c th·ª±c sinh tr·∫Øc h·ªçc
        window.credentialsRetrieved = function(data) {
            addLog('Credentials retrieved from app', 'success');
            
            // Format: userId:password
            const parts = data.split(':');
            if (parts.length === 2) {
                const userId = parts[0];
                const password = parts[1];
                
                addLog(`Auto-login with userId: ${userId}`, 'success');
                
                // T·ª± ƒë·ªông fill form
                userIdInput.value = userId;
                passwordInput.value = password;
                
                showMessage('‚úÖ X√°c th·ª±c th√†nh c√¥ng! ƒêang ƒëƒÉng nh·∫≠p...', 'success');
                
                // Auto submit sau 500ms
                setTimeout(() => {
                    biometricEnabled = false; // T·∫°m t·∫Øt ƒë·ªÉ kh√¥ng l∆∞u l·∫°i
                    loginForm.dispatchEvent(new Event('submit'));
                }, 500);
            } else {
                addLog('Invalid credentials format', 'error');
                showMessage('‚ùå L·ªói ƒë·ªãnh d·∫°ng d·ªØ li·ªáu', 'error');
            }
        };

        // Callback khi c√≥ l·ªói biometric
        window.biometricError = function(error) {
            addLog(`Biometric error: ${error}`, 'error');
            showMessage(`‚ùå ${error}`, 'error');
        };

        // Callback khi check biometric available
        window.biometricAvailable = function(available) {
            addLog(`Biometric available: ${available}`, 'info');
            if (available === 'false') {
                showMessage('‚ö†Ô∏è Thi·∫øt b·ªã kh√¥ng h·ªó tr·ª£ sinh tr·∫Øc h·ªçc', 'error');
                toggleSwitch.style.display = 'none';
            }
        };

        // ==================== INITIALIZATION ====================
        window.addEventListener('load', () => {
            addLog('WebView loaded successfully', 'success');
            
            // Ki·ªÉm tra channel
            if (window.nativeMethod) {
                addLog('‚úì nativeMethod channel detected', 'success');
                
                // Ki·ªÉm tra biometric c√≥ available kh√¥ng
                sendToApp('biometric', 'check_biometric_available');
            } else {
                addLog('‚ö† nativeMethod channel NOT detected', 'error');
            }
            
            // Ki·ªÉm tra biometric ƒë√£ ƒë∆∞·ª£c enable tr∆∞·ªõc ƒë√≥ ch∆∞a
            const wasBiometricEnabled = localStorage.getItem('biometricEnabled') === 'true';
            const lastUserId = localStorage.getItem('lastUserId');
            
            if (wasBiometricEnabled && lastUserId) {
                biometricEnabled = true;
                toggleSwitch.classList.add('active');
                biometricLoginBtn.classList.add('show');
                addLog(`Biometric previously enabled for user: ${lastUserId}`, 'info');
                showMessage(`Ch√†o m·ª´ng tr·ªü l·∫°i! B·∫°n c√≥ th·ªÉ d√πng sinh tr·∫Øc h·ªçc.`, 'info');
            }
        });
    </script>
</body>
</html>